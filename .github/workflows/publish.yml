name: Release â€” publish to npm (manual)

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Choose release type (patch, minor, major). If you provide "version" that one will be used instead.'
        required: false
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      version:
        description: 'Optional explicit version (e.g. 1.2.3). If set, this exact version will be used.'
        required: false
        type: string
      branch:
        description: 'Branch to push the version bump to (master/main).'
        required: false
        default: 'master'
        type: string
      dry_run:
        description: 'Dry run mode: test the release without publishing or pushing'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  id-token: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.event.inputs.branch }}

      # Sync with latest changes
      - name: Pull latest changes
        run: |
          git pull origin ${{ github.event.inputs.branch }} --rebase
          CURRENT_VERSION=$(node -p 'require("./package.json").version')
          echo "ðŸ“¦ Current version: $CURRENT_VERSION"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: https://registry.npmjs.org/

      - name: Configure npm auth
        if: ${{ github.event.inputs.dry_run != 'true' }}
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [ -z "$NPM_TOKEN" ]; then
            echo "âŒ Error: NPM_TOKEN secret is not set"
            exit 1
          fi
          printf "//registry.npmjs.org/:_authToken=%s\n" "$NPM_TOKEN" > ~/.npmrc

      - name: Install dependencies
        run: |
          if [ -f "package-lock.json" ]; then
            npm ci
          else
            npm install
          fi

      - name: Build
        run: |
          if npm run | grep -q "build"; then
            echo "ðŸ”¨ Running build..."
            npm run build
          else
            echo "No build script found"
          fi

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump version in package.json
        id: version
        run: |
          INPUT_VERSION="${{ github.event.inputs.version }}"
          RELEASE_TYPE="${{ github.event.inputs.release_type }}"
          DRY_RUN="${{ github.event.inputs.dry_run }}"
          
          CURRENT=$(node -p 'require("./package.json").version')
          echo "Current version: $CURRENT"
          
          if [ -n "$INPUT_VERSION" ]; then
            # Validar formato semver
            if ! echo "$INPUT_VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?(\+[a-zA-Z0-9.-]+)?$'; then
              echo "âŒ Invalid version format: $INPUT_VERSION"
              exit 1
            fi
            
            if [ "$INPUT_VERSION" = "$CURRENT" ]; then
              echo "âš ï¸ Warning: Version $INPUT_VERSION is the same as current version"
              echo "No version bump needed"
              NEW_VERSION="$CURRENT"
            else
              echo "Setting explicit version: $INPUT_VERSION"
              npm version "$INPUT_VERSION" --no-git-tag-version
              NEW_VERSION="$INPUT_VERSION"
            fi
          else
            echo "Bumping $RELEASE_TYPE version"
            NEW_VERSION=$(npm version "$RELEASE_TYPE" --no-git-tag-version | sed 's/v//')
          fi
          
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ New version: $NEW_VERSION"
          
          if [ "$DRY_RUN" = "true" ]; then
            echo "ðŸ§ª DRY RUN - Reverting version changes"
            git checkout -- package.json package-lock.json 2>/dev/null || git checkout -- package.json
          fi

      - name: Dry-run validation
        if: ${{ github.event.inputs.dry_run == 'true' }}
        run: |
          echo "ðŸ§ª DRY RUN MODE - Testing release process..."
          
          # Aplicar versiÃ³n temporalmente
          npm version ${{ steps.version.outputs.NEW_VERSION }} --no-git-tag-version
          
          # Validar package.json
          node -e "const pkg = require('./package.json'); if (!pkg.name || !pkg.version) { throw new Error('Invalid package.json'); }"
          
          # Test prerelease checks
          if npm run | grep -q "prepublishOnly"; then
            echo "Running prepublishOnly checks..."
            npm run prepublishOnly || echo "âš ï¸ Prerelease checks failed (may be expected in dry-run)"
          fi
          
          # Test pack
          echo "Testing npm pack..."
          npm pack --dry-run
          
          echo "âœ… Dry-run validation passed!"
          echo "ðŸ“¦ Would publish version: ${{ steps.version.outputs.NEW_VERSION }}"

      - name: Commit version bump
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          # Verificar si hay cambios en package.json
          if git diff --exit-code package.json package-lock.json 2>/dev/null || git diff --exit-code package.json; then
            echo "âš ï¸ No version changes detected, skipping commit"
          else
            VERSION="${{ steps.version.outputs.NEW_VERSION }}"
            git add package.json package-lock.json 2>/dev/null || git add package.json
            git commit -m "chore(release): bump version to $VERSION"
            echo "âœ… Version bump committed"
          fi

      - name: Run n8n release
        if: ${{ github.event.inputs.dry_run != 'true' }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.NEW_VERSION }}"
          echo "ðŸš€ Publishing version $VERSION to npm..."
          
          # n8n-node release hace:
          # - Crea git tag basado en la versiÃ³n actual del package.json
          # - Publica a npm
          npm run release
          
          echo "âœ… Package published to npm!"

      - name: Push changes to repository
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          BRANCH="${{ github.event.inputs.branch }}"
          
          # Configurar remote con token
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          
          # Push commit y tags
          echo "Pushing changes to $BRANCH..."
          git push origin HEAD:$BRANCH --follow-tags
          
          echo "âœ… Changes pushed successfully!"

      - name: Cleanup
        if: always()
        run: rm -f ~/.npmrc || true

      - name: Summary
        if: always()
        run: |
          VERSION="${{ steps.version.outputs.NEW_VERSION }}"
          DRY_RUN="${{ github.event.inputs.dry_run }}"
          
          if [ "$DRY_RUN" = "true" ]; then
            echo "# ðŸ§ª Dry Run Complete" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… All checks passed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Would release version:** $VERSION" >> $GITHUB_STEP_SUMMARY
            echo "**Current version:** $(node -p 'require("./package.json").version')" >> $GITHUB_STEP_SUMMARY
            echo "**Branch:** ${{ github.event.inputs.branch }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ No changes were made" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ job.status }}" = "success" ]; then
            PACKAGE_NAME=$(node -p 'require("./package.json").name')
            echo "# âœ… Release v${VERSION} Published!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
            echo "**Branch:** ${{ github.event.inputs.branch }}" >> $GITHUB_STEP_SUMMARY
            echo "**npm:** https://www.npmjs.com/package/${PACKAGE_NAME}/v/${VERSION}" >> $GITHUB_STEP_SUMMARY
            echo "**Repository:** https://github.com/${{ github.repository }}/releases/tag/v${VERSION}" >> $GITHUB_STEP_SUMMARY
          fi
