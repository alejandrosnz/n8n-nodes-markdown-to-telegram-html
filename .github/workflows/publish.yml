name: Release â€” publish to npm (manual)

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Choose release type'
        required: false
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      branch:
        description: 'Branch to use for release'
        required: false
        default: 'master'
        type: string
      dry_run:
        description: 'Dry run mode: test without publishing'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  id-token: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.event.inputs.branch }}

      - name: Pull latest changes
        run: |
          git pull origin ${{ github.event.inputs.branch }}
          CURRENT_VERSION=$(node -p 'require("./package.json").version')
          echo "ðŸ“¦ Current version: $CURRENT_VERSION"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: https://registry.npmjs.org/

      - name: Configure npm auth
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [ -z "$NPM_TOKEN" ]; then
            echo "âŒ Error: NPM_TOKEN secret is not set"
            exit 1
          fi
          printf "//registry.npmjs.org/:_authToken=%s\n" "$NPM_TOKEN" > ~/.npmrc

      - name: Install dependencies
        run: |
          if [ -f "package-lock.json" ]; then
            npm ci
          else
            npm install
          fi

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Configure remote with authentication for release-it push
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git

      - name: Calculate next version (preview)
        id: version
        run: |
          RELEASE_TYPE="${{ github.event.inputs.release_type }}"
          CURRENT=$(node -p 'require("./package.json").version')
          
          # Calculate next version for display purposes
          if [ "$RELEASE_TYPE" = "major" ]; then
            NEXT=$(node -p "const v = require('./package.json').version.split('.'); [parseInt(v[0])+1, 0, 0].join('.')")
          elif [ "$RELEASE_TYPE" = "minor" ]; then
            NEXT=$(node -p "const v = require('./package.json').version.split('.'); [v[0], parseInt(v[1])+1, 0].join('.')")
          else
            NEXT=$(node -p "const v = require('./package.json').version.split('.'); [v[0], v[1], parseInt(v[2])+1].join('.')")
          fi
          
          echo "CURRENT_VERSION=$CURRENT" >> $GITHUB_OUTPUT
          echo "NEXT_VERSION=$NEXT" >> $GITHUB_OUTPUT
          echo ""
          echo "ðŸ“¦ Release preview:"
          echo "   Type: $RELEASE_TYPE"
          echo "   Current: $CURRENT"
          echo "   Next: $NEXT"
          echo ""

      - name: Dry-run release
        if: ${{ github.event.inputs.dry_run == 'true' }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ§ª DRY RUN MODE"
          echo ""
          echo "Testing release process for: ${{ steps.version.outputs.NEXT_VERSION }}"
          echo ""
          
          # Run release-it in dry-run mode with increment flag
          npm run release -- --increment=${{ github.event.inputs.release_type }} --dry-run --ci
          
          echo ""
          echo "âœ… Dry-run completed successfully!"
          echo "No changes were made to the repository or npm."

      - name: Run release
        if: ${{ github.event.inputs.dry_run != 'true' }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸš€ Starting release process..."
          echo ""
          echo "Release type: ${{ github.event.inputs.release_type }}"
          echo "Expected version: ${{ steps.version.outputs.NEXT_VERSION }}"
          echo ""
          
          # release-it will execute:
          # 1. npm run lint && npm run build (hooks)
          # 2. Bump version based on release_type
          # 3. Generate changelog with auto-changelog
          # 4. Git commit and tag
          # 5. npm publish
          # 6. Git push with tags
          npm run release -- --increment=${{ github.event.inputs.release_type }} --ci
          
          echo ""
          echo "âœ… Release completed!"

      - name: Verify release
        if: ${{ github.event.inputs.dry_run != 'true' && success() }}
        run: |
          # Update local repo after release
          git pull origin ${{ github.event.inputs.branch }}
          
          FINAL_VERSION=$(node -p 'require("./package.json").version')
          EXPECTED_VERSION="${{ steps.version.outputs.NEXT_VERSION }}"
          
          echo "ðŸ“¦ Published version: $FINAL_VERSION"
          
          if [ "$FINAL_VERSION" = "$EXPECTED_VERSION" ]; then
            echo "âœ… Version matches expected: $EXPECTED_VERSION"
          else
            echo "âš ï¸ Warning: Version mismatch!"
            echo "   Expected: $EXPECTED_VERSION"
            echo "   Got: $FINAL_VERSION"
          fi
          
          # Save for summary step
          echo "FINAL_VERSION=$FINAL_VERSION" >> $GITHUB_OUTPUT
        id: verify

      - name: Cleanup
        if: always()
        run: rm -f ~/.npmrc || true

      - name: Summary
        if: always()
        run: |
          DRY_RUN="${{ github.event.inputs.dry_run }}"
          
          if [ "$DRY_RUN" = "true" ]; then
            echo "# ðŸ§ª Dry Run Complete" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… All checks passed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Release type:** ${{ github.event.inputs.release_type }}" >> $GITHUB_STEP_SUMMARY
            echo "**Current version:** ${{ steps.version.outputs.CURRENT_VERSION }}" >> $GITHUB_STEP_SUMMARY
            echo "**Would release:** ${{ steps.version.outputs.NEXT_VERSION }}" >> $GITHUB_STEP_SUMMARY
            echo "**Branch:** ${{ github.event.inputs.branch }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ No changes were made" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ job.status }}" = "success" ]; then
            VERSION="${{ steps.verify.outputs.FINAL_VERSION }}"
            PACKAGE_NAME=$(node -p 'require("./package.json").name')
            
            echo "# âœ… Release v${VERSION} Published!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
            echo "**Release type:** ${{ github.event.inputs.release_type }}" >> $GITHUB_STEP_SUMMARY
            echo "**Branch:** ${{ github.event.inputs.branch }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“¦ Links" >> $GITHUB_STEP_SUMMARY
            echo "- **npm:** https://www.npmjs.com/package/${PACKAGE_NAME}/v/${VERSION}" >> $GITHUB_STEP_SUMMARY
            echo "- **GitHub Release:** https://github.com/${{ github.repository }}/releases/tag/${VERSION}" >> $GITHUB_STEP_SUMMARY
          fi
