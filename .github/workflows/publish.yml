name: Release â€” publish to npm (manual)

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Choose release type (patch, minor, major). If you provide "version" that one will be used instead.'
        required: false
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      version:
        description: 'Optional explicit version (e.g. 1.2.3). If set, this exact version will be used.'
        required: false
        type: string
      branch:
        description: 'Branch to push the version bump to (master/main).'
        required: false
        default: 'master'
        type: string
      dry_run:
        description: 'Dry run mode: test the release without publishing or pushing'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  id-token: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: https://registry.npmjs.org/

      - name: Configure npm auth
        if: ${{ github.event.inputs.dry_run != 'true' }}
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [ -z "$NPM_TOKEN" ]; then
            echo "Error: NPM_TOKEN secret is not set"
            exit 1
          fi
          # Write token to .npmrc for publish
          printf "//registry.npmjs.org/:_authToken=%s\n" "$NPM_TOKEN" > ~/.npmrc
          # Optional: ensure npm uses the registry for this session
          npm config set registry https://registry.npmjs.org/

      - name: Install dependencies
        run: |
          if [ -f "package-lock.json" ]; then
            echo "package-lock.json found, running npm ci"
            npm ci
          else
            echo "No package-lock.json found, running npm install"
            npm install
          fi

      - name: Build (if you have a build step)
        run: |
          if npm run | grep -q "build"; then
            echo "Build script found, running build"
            npm run build
          else
            echo "No build script found, skipping build"
          fi
        continue-on-error: false

      - name: Configure git for version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Validate version input (if provided)
        if: ${{ github.event.inputs.version != '' }}
        run: |
          INPUT_VERSION="${{ github.event.inputs.version }}"
          # Validate semver format (basic validation)
          if ! echo "$INPUT_VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?(\+[a-zA-Z0-9.-]+)?$'; then
            echo "Error: Invalid version format '$INPUT_VERSION'. Expected semver format (e.g., 1.2.3)"
            exit 1
          fi
          echo "Version format is valid: $INPUT_VERSION"

      - name: Bump version / create tag (locally)
        id: version
        shell: bash
        run: |
          set -euo pipefail

          # Read inputs
          INPUT_VERSION="${{ github.event.inputs.version }}"
          RELEASE_TYPE="${{ github.event.inputs.release_type }}"
          DRY_RUN="${{ github.event.inputs.dry_run }}"

          if [ "$DRY_RUN" = "true" ]; then
            echo "ðŸ§ª DRY RUN MODE - No changes will be committed"
          fi

          if [ -n "$INPUT_VERSION" ]; then
            echo "Using explicit version: $INPUT_VERSION"
            CURRENT=$(node -p 'require("./package.json").version')
            echo "Current package.json version: $CURRENT"
            if [ "$INPUT_VERSION" = "$CURRENT" ]; then
              echo "Version unchanged ($CURRENT). Will create tag only."
              if [ "$DRY_RUN" != "true" ]; then
                git tag "v$CURRENT"
              fi
            else
              if [ "$DRY_RUN" = "true" ]; then
                echo "Would run: npm version $INPUT_VERSION -m 'chore(release): %s' --no-git-tag-version"
                npm version "$INPUT_VERSION" --no-git-tag-version
              else
                npm version "$INPUT_VERSION" -m "chore(release): %s"
              fi
            fi
          else
            echo "No explicit version provided, bumping $RELEASE_TYPE"
            if [ "$DRY_RUN" = "true" ]; then
              echo "Would run: npm version $RELEASE_TYPE -m 'chore(release): %s' --no-git-tag-version"
              npm version "$RELEASE_TYPE" --no-git-tag-version
            else
              npm version "$RELEASE_TYPE" -m "chore(release): %s"
            fi
          fi

          # Export the current package.json version for following steps
          VERSION_CURRENT=$(node -p 'require("./package.json").version')
          echo "VERSION=$VERSION_CURRENT" >> $GITHUB_OUTPUT
          echo "New version: $VERSION_CURRENT"

      - name: Test publish (dry-run validation)
        if: ${{ github.event.inputs.dry_run == 'true' }}
        run: |
          echo "ðŸ§ª Testing npm publish (dry-run)..."
          if npm run | grep -q "release"; then
            echo "Note: Using 'npm run release' - ensure it supports dry-run or test manually"
            echo "Alternatively, testing with: npm publish --dry-run"
            npm publish --dry-run
          else
            npm publish --dry-run
          fi
          echo "âœ… Dry-run validation passed!"

      - name: Publish to npm
        if: ${{ github.event.inputs.dry_run != 'true' }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "Publishing to npm using n8n release command..."
          npm run release
          echo "âœ… Package published successfully to npm!"

      - name: Push commit and tags
        if: ${{ github.event.inputs.dry_run != 'true' }}
        env:
          BRANCH: ${{ github.event.inputs.branch }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Configure git remote with authentication
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git
          
          # Push the new commit and tags back to repo
          echo "Pushing to branch: ${BRANCH}"
          git push origin HEAD:"${BRANCH}"
          
          echo "Pushing tags"
          git push --tags
          echo "âœ… Changes pushed to repository!"

      - name: Cleanup .npmrc
        if: always()
        run: |
          rm -f ~/.npmrc || true

      - name: Dry-run Summary
        if: ${{ github.event.inputs.dry_run == 'true' }}
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          echo "# ðŸ§ª Dry Run Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All checks passed! The following would happen in a real release:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.event.inputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **No changes were committed or published**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To perform the actual release, run this workflow again with dry_run disabled." >> $GITHUB_STEP_SUMMARY

      - name: Release Summary
        if: ${{ success() && github.event.inputs.dry_run != 'true' }}
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          echo "# âœ… Release v${VERSION} Published Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.event.inputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **npm package**: https://www.npmjs.com/package/$(node -p 'require(\"./package.json\").name')/v/${VERSION}" >> $GITHUB_STEP_SUMMARY
