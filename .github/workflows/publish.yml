name: Release â€” publish to npm (manual)

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Choose release type (auto-increases version). Ignored if custom_version is set.'
        required: false
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      custom_version:
        description: 'Optional: Specify exact version (e.g., 1.2.3). If provided, release_type is ignored.'
        required: false
        type: string
      branch:
        description: 'Branch to use for release'
        required: false
        default: 'master'
        type: string
      dry_run:
        description: 'Dry run mode: test without publishing'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  id-token: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.event.inputs.branch }}

      - name: Pull latest changes
        run: |
          git pull origin ${{ github.event.inputs.branch }}
          CURRENT_VERSION=$(node -p 'require("./package.json").version')
          echo "ðŸ“¦ Current version: $CURRENT_VERSION"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: https://registry.npmjs.org/

      - name: Configure npm auth
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          if [ -z "$NPM_TOKEN" ]; then
            echo "âŒ Error: NPM_TOKEN secret is not set"
            exit 1
          fi
          printf "//registry.npmjs.org/:_authToken=%s\n" "$NPM_TOKEN" > ~/.npmrc

      - name: Install dependencies
        run: |
          if [ -f "package-lock.json" ]; then
            npm ci
          else
            npm install
          fi

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Configure remote with authentication for release-it push
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git

      - name: Calculate next version
        id: version
        run: |
          CUSTOM_VERSION="${{ github.event.inputs.custom_version }}"
          
          if [ -n "$CUSTOM_VERSION" ]; then
            # Validate custom version format (basic semver check)
            if ! echo "$CUSTOM_VERSION" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$' > /dev/null; then
              echo "âŒ Invalid version format: $CUSTOM_VERSION"
              echo "Expected format: x.y.z or x.y.z-prerelease"
              exit 1
            fi
            
            NEXT_VERSION="$CUSTOM_VERSION"
            RELEASE_TYPE="custom"
          else
            RELEASE_TYPE="${{ github.event.inputs.release_type }}"
            CURRENT=$(node -p 'require("./package.json").version')
            
            # Calculate next version based on release_type
            if [ "$RELEASE_TYPE" = "major" ]; then
              NEXT=$(node -p "const v = require('./package.json').version.split('.'); [parseInt(v[0])+1, 0, 0].join('.')")
            elif [ "$RELEASE_TYPE" = "minor" ]; then
              NEXT=$(node -p "const v = require('./package.json').version.split('.'); [v[0], parseInt(v[1])+1, 0].join('.')")
            else
              NEXT=$(node -p "const v = require('./package.json').version.split('.'); [v[0], v[1], parseInt(v[2])+1].join('.')")
            fi
            
            NEXT_VERSION="$NEXT"
          fi
          
          echo "CURRENT_VERSION=$(node -p 'require("./package.json").version')" >> $GITHUB_OUTPUT
          echo "NEXT_VERSION=$NEXT_VERSION" >> $GITHUB_OUTPUT
          echo "RELEASE_TYPE=$RELEASE_TYPE" >> $GITHUB_OUTPUT
          echo ""
          echo "ðŸ“¦ Release plan:"
          echo "   Type: $RELEASE_TYPE"
          echo "   Current: $(node -p 'require("./package.json").version')"
          echo "   Next: $NEXT_VERSION"

      - name: Manual version bump
        if: ${{ github.event.inputs.custom_version != '' || github.event.inputs.release_type != 'patch' }}
        run: |
          RELEASE_TYPE="${{ steps.version.outputs.RELEASE_TYPE }}"
          CUSTOM_VERSION="${{ github.event.inputs.custom_version }}"
          
          if [ -n "$CUSTOM_VERSION" ]; then
            TARGET_VERSION="$CUSTOM_VERSION"
            echo "Setting exact version to: $TARGET_VERSION"
          else
            TARGET_VERSION="${{ steps.version.outputs.NEXT_VERSION }}"
            echo "Pre-bumping version for $RELEASE_TYPE release..."
          fi
          
          npm version $TARGET_VERSION --no-git-tag-version
          
          NEW_VERSION=$(node -p 'require("./package.json").version')
          echo "âœ… Version updated to: $NEW_VERSION"
          
          # Commit the version bump
          git add package.json package-lock.json 2>/dev/null || git add package.json
          git commit -m "chore: bump version to $NEW_VERSION"
          echo "âœ… Version bump committed"

      - name: Dry-run release
        if: ${{ github.event.inputs.dry_run == 'true' }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ§ª DRY RUN MODE"
          echo ""
          echo "Would release version: ${{ steps.version.outputs.NEXT_VERSION }}"
          echo ""
          
          # Validate package can be built and packed
          npm run build || echo "Build step not found or failed"
          npm pack --dry-run
          
          echo ""
          echo "âœ… Dry-run validation completed!"
          echo "No changes were made to the repository or npm."
          
          # Revert any version changes
          git checkout -- package.json package-lock.json 2>/dev/null || git checkout -- package.json

      - name: Run release
        if: ${{ github.event.inputs.dry_run != 'true' }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸš€ Starting release process..."
          echo ""
          
          CURRENT_VERSION=$(node -p 'require("./package.json").version')
          echo "Current version in package.json: $CURRENT_VERSION"
          echo ""
          
          # Build and prepare for release
          npm run build || echo "Build step not found or failed"
          
          # Determine release command
          CUSTOM_VERSION="${{ github.event.inputs.custom_version }}"
          if [ -n "$CUSTOM_VERSION" ]; then
            echo "Using custom version: $CUSTOM_VERSION"
            # Use --no-increment to prevent release-it from bumping the version
            npm run release -- --no-increment --version="$CUSTOM_VERSION"
          else
            npm run release
          fi
          
          echo ""
          echo "âœ… Release completed!"

      - name: Verify release
        if: ${{ github.event.inputs.dry_run != 'true' && success() }}
        run: |
          # Update local repo after release
          git pull origin ${{ github.event.inputs.branch }}
          
          FINAL_VERSION=$(node -p 'require("./package.json").version')
          EXPECTED_VERSION="${{ steps.version.outputs.NEXT_VERSION }}"
          
          echo "ðŸ“¦ Published version: $FINAL_VERSION"
          
          if [ "$FINAL_VERSION" = "$EXPECTED_VERSION" ]; then
            echo "âœ… Version matches expected: $EXPECTED_VERSION"
          else
            echo "âš ï¸ Note: Version is $FINAL_VERSION (expected $EXPECTED_VERSION)"
            echo "This can happen if release-it applied additional bumps"
          fi
          
          # Save for summary step
          echo "FINAL_VERSION=$FINAL_VERSION" >> $GITHUB_OUTPUT
        id: verify

      - name: Cleanup
        if: always()
        run: rm -f ~/.npmrc || true

      - name: Summary
        if: always()
        run: |
          DRY_RUN="${{ github.event.inputs.dry_run }}"
          CUSTOM_VERSION="${{ github.event.inputs.custom_version }}"
          
          if [ "$DRY_RUN" = "true" ]; then
            echo "# ðŸ§ª Dry Run Complete" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… All checks passed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ -n "$CUSTOM_VERSION" ]; then
              echo "**Custom version:** $CUSTOM_VERSION" >> $GITHUB_STEP_SUMMARY
            else
              echo "**Release type:** ${{ github.event.inputs.release_type }}" >> $GITHUB_STEP_SUMMARY
            fi
            echo "**Current version:** ${{ steps.version.outputs.CURRENT_VERSION }}" >> $GITHUB_STEP_SUMMARY
            echo "**Would release:** ${{ steps.version.outputs.NEXT_VERSION }}" >> $GITHUB_STEP_SUMMARY
            echo "**Branch:** ${{ github.event.inputs.branch }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ No changes were made" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ job.status }}" = "success" ]; then
            VERSION="${{ steps.verify.outputs.FINAL_VERSION }}"
            PACKAGE_NAME=$(node -p 'require("./package.json").name')
            
            echo "# âœ… Release v${VERSION} Published!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
            if [ -n "$CUSTOM_VERSION" ]; then
              echo "**Custom version:** $CUSTOM_VERSION" >> $GITHUB_STEP_SUMMARY
            else
              echo "**Release type:** ${{ github.event.inputs.release_type }}" >> $GITHUB_STEP_SUMMARY
            fi
            echo "**Branch:** ${{ github.event.inputs.branch }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“¦ Links" >> $GITHUB_STEP_SUMMARY
            echo "- **npm:** https://www.npmjs.com/package/${PACKAGE_NAME}/v/${VERSION}" >> $GITHUB_STEP_SUMMARY
            echo "- **GitHub Release:** https://github.com/${{ github.repository }}/releases/tag/${VERSION}" >> $GITHUB_STEP_SUMMARY
          fi
